syntax = "proto3";

package aegis.identity.v1;

option go_package = "github.com/zoobzio/aegis/proto/identity";

// IdentityService provides identity operations for mesh services.
// Implemented by morpheus, consumed by other services requiring authentication.
service IdentityService {
  // ValidateSession checks if a session token is valid and returns user info.
  rpc ValidateSession(ValidateSessionRequest) returns (ValidateSessionResponse);

  // GetUser retrieves a user by ID.
  rpc GetUser(GetUserRequest) returns (GetUserResponse);

  // GetUserByEmail retrieves a user by email address.
  rpc GetUserByEmail(GetUserByEmailRequest) returns (GetUserResponse);

  // ListProviders returns the OAuth providers linked to a user.
  rpc ListProviders(ListProvidersRequest) returns (ListProvidersResponse);

  // RevokeSession revokes a specific session by token.
  rpc RevokeSession(RevokeSessionRequest) returns (RevokeSessionResponse);

  // RevokeUserSessions revokes all sessions for a user ("logout everywhere").
  rpc RevokeUserSessions(RevokeUserSessionsRequest) returns (RevokeUserSessionsResponse);

  // ListUserSessions lists active sessions for a user.
  rpc ListUserSessions(ListUserSessionsRequest) returns (ListUserSessionsResponse);
}

// ValidateSessionRequest contains the session token to validate.
message ValidateSessionRequest {
  string token = 1;
}

// ValidateSessionResponse contains validation result and user info if valid.
message ValidateSessionResponse {
  bool valid = 1;
  string user_id = 2;
  int64 expires_at = 3;  // Unix timestamp, 0 if invalid
}

// GetUserRequest identifies a user by ID.
message GetUserRequest {
  string user_id = 1;
}

// GetUserByEmailRequest identifies a user by email.
message GetUserByEmailRequest {
  string email = 1;
}

// GetUserResponse contains user information.
// Email is not masked in mesh responses - masking is a boundary concern.
message GetUserResponse {
  string id = 1;
  string email = 2;
  string name = 3;
  string avatar_url = 4;
  bool email_verified = 5;
  int64 created_at = 6;  // Unix timestamp
}

// ListProvidersRequest identifies the user whose providers to list.
message ListProvidersRequest {
  string user_id = 1;
}

// ListProvidersResponse contains the user's linked OAuth providers.
message ListProvidersResponse {
  repeated Provider providers = 1;
}

// Provider represents a linked OAuth provider.
message Provider {
  string type = 1;             // "github" or "google"
  string provider_user_id = 2; // External provider's user ID
  int64 linked_at = 3;         // Unix timestamp
}

// RevokeSessionRequest identifies the session to revoke.
message RevokeSessionRequest {
  string token = 1;
}

// RevokeSessionResponse indicates revocation success.
message RevokeSessionResponse {
  bool success = 1;
}

// RevokeUserSessionsRequest identifies the user whose sessions to revoke.
message RevokeUserSessionsRequest {
  string user_id = 1;
}

// RevokeUserSessionsResponse contains the count of revoked sessions.
message RevokeUserSessionsResponse {
  int32 revoked_count = 1;
}

// ListUserSessionsRequest identifies the user whose sessions to list.
message ListUserSessionsRequest {
  string user_id = 1;
}

// ListUserSessionsResponse contains the user's active sessions.
message ListUserSessionsResponse {
  repeated SessionInfo sessions = 1;
}

// SessionInfo contains information about an active session.
message SessionInfo {
  string token_prefix = 1;  // First N chars for identification, not full token
  int64 created_at = 2;     // Unix timestamp
  int64 expires_at = 3;     // Unix timestamp
  string user_agent = 4;    // Device/browser info
  string ip_address = 5;    // Last known IP
}
