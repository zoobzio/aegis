syntax = "proto3";

package aegis.authorization.v1;

option go_package = "github.com/zoobzio/aegis/proto/authorization";

// AuthorizationService provides capability-based authorization across the mesh.
// Services get tokens from morpheus (the authorization authority) and validate
// cross-service calls against registered guards.
service AuthorizationService {
  // GetToken returns a token for the calling service.
  // Certificate is extracted from mTLS context.
  rpc GetToken(GetTokenRequest) returns (GetTokenResponse);

  // RegisterGuard registers a guard that protects a capability.
  rpc RegisterGuard(RegisterGuardRequest) returns (RegisterGuardResponse);

  // ValidateGuard validates a token against a registered guard.
  rpc ValidateGuard(ValidateGuardRequest) returns (ValidateGuardResponse);

  // RevokeToken revokes a token by certificate fingerprint.
  rpc RevokeToken(RevokeTokenRequest) returns (RevokeTokenResponse);
}

// GetTokenRequest is empty - certificate comes from mTLS context.
message GetTokenRequest {}

// GetTokenResponse contains the issued token and expiration.
message GetTokenResponse {
  string token = 1;
  int64 expires_at = 2;  // Unix timestamp
}

// RegisterGuardRequest defines a guard for a capability.
message RegisterGuardRequest {
  string guard_id = 1;              // e.g. "vicky.storage.write"
  repeated string permissions = 2;  // Required permissions
}

// RegisterGuardResponse is empty on success; errors use gRPC status.
message RegisterGuardResponse {}

// ValidateGuardRequest checks a token against a guard.
message ValidateGuardRequest {
  string guard_id = 1;
  string token = 2;
}

// ValidateGuardResponse indicates whether access is allowed.
message ValidateGuardResponse {
  bool allowed = 1;
  repeated string missing_permissions = 2;  // If denied, what's missing
}

// RevokeTokenRequest identifies the token to revoke.
message RevokeTokenRequest {
  string fingerprint = 1;  // Certificate fingerprint
}

// RevokeTokenResponse is empty on success; errors use gRPC status.
message RevokeTokenResponse {}
