package security

import (
	"fmt"
	"time"

	"github.com/spf13/cobra"
	
	"aegis/moisten"
)

// NewSecurityTestCmd creates the security domain test command
func NewSecurityTestCmd() *cobra.Command {
	cmd := &cobra.Command{
		Use:   "security",
		Short: "üîí Test security capabilities",
		Long: `
üîí SECURITY CAPABILITIES
========================

Tests the framework's security capabilities including:
‚Ä¢ Context identity management (user vs system)
‚Ä¢ Permission boundaries and access control
‚Ä¢ Security context extensibility
‚Ä¢ Security event generation and auditing
‚Ä¢ Cross-service context propagation
‚Ä¢ Dynamic security posture management

These tests demonstrate security as a cross-cutting
concern without exposing implementation details.`,
		Run: runAllSecurityTests,
	}

	// Add subcommands for each capability area
	cmd.AddCommand(&cobra.Command{
		Use:   "identity",
		Short: "Context identity management",
		Run:   runIdentityTests,
	})

	cmd.AddCommand(&cobra.Command{
		Use:   "permissions",
		Short: "Permission boundaries",
		Run:   runPermissionsTests,
	})

	cmd.AddCommand(&cobra.Command{
		Use:   "extensions",
		Short: "Context extensibility",
		Run:   runExtensionsTests,
	})

	cmd.AddCommand(&cobra.Command{
		Use:   "events",
		Short: "Security event generation",
		Run:   runEventsTests,
	})

	cmd.AddCommand(&cobra.Command{
		Use:   "propagation",
		Short: "Context propagation",
		Run:   runPropagationTests,
	})

	cmd.AddCommand(&cobra.Command{
		Use:   "serialization",
		Short: "Serialization security scenarios",
		Run:   runSerializationTests,
	})

	return cmd
}

// runAllSecurityTests runs all tests in the security domain
func runAllSecurityTests(cmd *cobra.Command, args []string) {
	fmt.Println("\nüîí SECURITY CAPABILITIES")
	fmt.Println("========================")
	
	moisten.ForTesting()
	
	// Run all test suites
	fmt.Println("\n‚ñ∂ Context Identity Tests")
	runIdentityTests(cmd, args)
	
	fmt.Println("\n‚ñ∂ Permission Boundary Tests")
	runPermissionsTests(cmd, args)
	
	fmt.Println("\n‚ñ∂ Context Extensibility Tests")
	runExtensionsTests(cmd, args)
	
	fmt.Println("\n‚ñ∂ Security Event Tests")
	runEventsTests(cmd, args)
	
	fmt.Println("\n‚ñ∂ Context Propagation Tests")
	runPropagationTests(cmd, args)
	
	fmt.Println("\n‚ñ∂ Security Logging Tests")
	runLoggingTests(cmd, args)
	
	fmt.Println("\n‚ñ∂ Serialization Security Scenarios")
	runSerializationTests(cmd, args)
}

// Helper function to run individual tests
func runTest(name string, testFunc func() error) {
	start := time.Now()
	err := testFunc()
	duration := time.Since(start)
	
	if err != nil {
		fmt.Printf("‚ùå %s - FAILED: %v (%v)\n", name, err, duration)
	} else {
		fmt.Printf("‚úÖ %s - PASSED (%v)\n", name, duration)
	}
}