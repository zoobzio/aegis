package extensibility

import (
	"fmt"
	"time"

	"github.com/spf13/cobra"
	
	"aegis/moisten"
)

// NewExtensibilityTestCmd creates the extensibility domain test command
func NewExtensibilityTestCmd() *cobra.Command {
	cmd := &cobra.Command{
		Use:   "extensibility",
		Short: "üîß Test extensibility capabilities",
		Long: `
üîß EXTENSIBILITY CAPABILITIES
=============================

Tests the framework's revolutionary extensibility features:
‚Ä¢ Divergent behaviors through type signatures
‚Ä¢ Convention-based discovery patterns
‚Ä¢ Behavior composition and pipelines
‚Ä¢ Type-safe contracts
‚Ä¢ Zero-coordination extension

These tests prove the core innovation: the same string
can mean completely different things based on type context.`,
		Run: runAllExtensibilityTests,
	}

	// Add subcommands for each test file
	cmd.AddCommand(&cobra.Command{
		Use:   "divergent",
		Short: "Type signature divergent behaviors",
		Run:   runDivergentBehaviorTests,
	})

	cmd.AddCommand(&cobra.Command{
		Use:   "behaviors",
		Short: "Pipeline and behavior tests",
		Run:   runBehaviorTests,
	})

	cmd.AddCommand(&cobra.Command{
		Use:   "conventions",
		Short: "Convention discovery tests",
		Run:   runConventionTests,
	})

	cmd.AddCommand(&cobra.Command{
		Use:   "pipz",
		Short: "Core pipz contract tests",
		Run:   runPipzContractTests,
	})

	cmd.AddCommand(&cobra.Command{
		Use:   "emergent",
		Short: "Emergent behavior tests",
		Run:   runPipzEmergentTests,
	})

	// Temporarily disabled for build
	// cmd.AddCommand(&cobra.Command{
	//	Use:   "multitenancy", 
	//	Short: "Zero-config multi-tenancy tests",
	//	Run:   runZeroConfigMultitenancyTests,
	// })

	// Add the visual showcase
	cmd.AddCommand(ShowcaseInfiniteParallelismCmd())

	return cmd
}

// runAllExtensibilityTests runs all tests in the extensibility domain
func runAllExtensibilityTests(cmd *cobra.Command, args []string) {
	fmt.Println("\nüîß EXTENSIBILITY CAPABILITIES")
	fmt.Println("=============================")
	
	moisten.ForTesting()
	
	// Run all test suites
	fmt.Println("\n‚ñ∂ Divergent Behavior Tests (CORE INNOVATION)")
	runDivergentBehaviorTests(cmd, args)
	
	fmt.Println("\n‚ñ∂ Behavior Pipeline Tests")
	runBehaviorTests(cmd, args)
	
	fmt.Println("\n‚ñ∂ Convention Discovery Tests")
	runConventionTests(cmd, args)
	
	fmt.Println("\n‚ñ∂ Core pipz Contract Tests")
	runPipzContractTests(cmd, args)
}

// Helper function to run individual tests
func runTest(name string, testFunc func() error) {
	start := time.Now()
	err := testFunc()
	duration := time.Since(start)
	
	if err != nil {
		fmt.Printf("‚ùå %s - FAILED: %v (%v)\n", name, err, duration)
	} else {
		fmt.Printf("‚úÖ %s - PASSED (%v)\n", name, duration)
	}
}