---
title: API Reference
description: Function signatures and usage
author: zoobzio
published: 2025-02-18
updated: 2025-02-18
tags:
  - aegis
  - reference
  - api
---

# API Reference

This document covers the public API of aegis.

## Node Builder

### NewNodeBuilder

```go
func NewNodeBuilder() *NodeBuilder
```

Creates a new node builder with defaults:
- Type: `NodeTypeGeneric`
- CertDir: `"./certs"`

**Example:**

```go
builder := aegis.NewNodeBuilder()
```

### NodeBuilder.WithID

```go
func (nb *NodeBuilder) WithID(id string) *NodeBuilder
```

Sets the node ID. Required.

### NodeBuilder.WithName

```go
func (nb *NodeBuilder) WithName(name string) *NodeBuilder
```

Sets the node name. Required.

### NodeBuilder.WithType

```go
func (nb *NodeBuilder) WithType(nodeType NodeType) *NodeBuilder
```

Sets the node type. Optional, defaults to `NodeTypeGeneric`.

### NodeBuilder.WithAddress

```go
func (nb *NodeBuilder) WithAddress(address string) *NodeBuilder
```

Sets the node address (host:port). Required.

### NodeBuilder.WithServices

```go
func (nb *NodeBuilder) WithServices(services ...ServiceInfo) *NodeBuilder
```

Declares services this node provides. Optional.

### NodeBuilder.WithServiceRegistration

```go
func (nb *NodeBuilder) WithServiceRegistration(r ServiceRegistrar) *NodeBuilder
```

Adds a callback to register gRPC services. Called when server starts.

**Example:**

```go
WithServiceRegistration(func(s *grpc.Server) {
    identity.RegisterIdentityServiceServer(s, &myServer{})
})
```

### NodeBuilder.WithCertDir

```go
func (nb *NodeBuilder) WithCertDir(certDir string) *NodeBuilder
```

Sets the certificate directory. Certificates are generated if missing.

### NodeBuilder.WithTLSOptions

```go
func (nb *NodeBuilder) WithTLSOptions(opts *TLSOptions) *NodeBuilder
```

Sets custom TLS options. Overrides `WithCertDir`.

### NodeBuilder.Build

```go
func (nb *NodeBuilder) Build() (*Node, error)
```

Creates the node. Returns error if required fields missing or TLS setup fails.

---

## Node

### Node.StartServer

```go
func (n *Node) StartServer() error
```

Starts the gRPC server. Returns error if TLS not configured or bind fails.

### Node.Shutdown

```go
func (n *Node) Shutdown() error
```

Gracefully shuts down server and closes peer connections.

### Node.AddPeer

```go
func (n *Node) AddPeer(info PeerInfo) error
```

Adds a peer connection. Connection established on first use.

### Node.RemovePeer

```go
func (n *Node) RemovePeer(peerID string) error
```

Removes a peer and closes its connection.

### Node.GetPeer

```go
func (n *Node) GetPeer(peerID string) (*Peer, bool)
```

Returns a peer by ID.

### Node.GetAllPeers

```go
func (n *Node) GetAllPeers() []*Peer
```

Returns all connected peers.

### Node.PingPeer

```go
func (n *Node) PingPeer(ctx context.Context, peerID string) (*PingResponse, error)
```

Pings a peer and returns response with latency.

### Node.GetPeerHealth

```go
func (n *Node) GetPeerHealth(ctx context.Context, peerID string) (*HealthResponse, error)
```

Gets health status from a peer.

### Node.SyncTopology

```go
func (n *Node) SyncTopology(ctx context.Context, peerID string) error
```

Synchronizes topology with a specific peer.

### Node.SyncTopologyWithAllPeers

```go
func (n *Node) SyncTopologyWithAllPeers(ctx context.Context) error
```

Synchronizes topology with all connected peers.

### Node.SetHealth

```go
func (n *Node) SetHealth(status HealthStatus, message string, err error)
```

Sets the node's health status.

### Node.CheckHealth

```go
func (n *Node) CheckHealth(ctx context.Context, checker HealthChecker) error
```

Runs a health checker and updates status.

### Node.IsHealthy

```go
func (n *Node) IsHealthy() bool
```

Returns true if node status is healthy.

---

## Topology

### Topology.AddNode

```go
func (t *Topology) AddNode(info NodeInfo) error
```

Adds a node to topology. Error if node already exists.

### Topology.RemoveNode

```go
func (t *Topology) RemoveNode(nodeID string) error
```

Removes a node from topology. Error if not found.

### Topology.GetNode

```go
func (t *Topology) GetNode(nodeID string) (NodeInfo, bool)
```

Returns a node by ID.

### Topology.GetAllNodes

```go
func (t *Topology) GetAllNodes() []NodeInfo
```

Returns all nodes in topology.

### Topology.GetServiceProviders

```go
func (t *Topology) GetServiceProviders(name, version string) []NodeInfo
```

Returns nodes providing the specified service and version.

### Topology.GetNodesByService

```go
func (t *Topology) GetNodesByService(name string) []NodeInfo
```

Returns nodes providing any version of the specified service.

### Topology.GetVersion

```go
func (t *Topology) GetVersion() int64
```

Returns the topology version number.

---

## ServiceClientPool

### NewServiceClientPool

```go
func NewServiceClientPool(node *Node) *ServiceClientPool
```

Creates a connection pool for service clients.

### ServiceClientPool.GetConn

```go
func (p *ServiceClientPool) GetConn(ctx context.Context, name, version string) (*grpc.ClientConn, error)
```

Returns a connection to a service provider. Uses round-robin across providers.

**Errors:**
- `ErrNoProviders` — No nodes provide this service
- `ErrNoTLSConfig` — Node has no TLS configuration

### ServiceClientPool.Close

```go
func (p *ServiceClientPool) Close() error
```

Closes all connections in the pool.

---

## ServiceClient

### NewServiceClient

```go
func NewServiceClient[T any](pool *ServiceClientPool, name, version string, newClient func(grpc.ClientConnInterface) T) *ServiceClient[T]
```

Creates a typed service client.

**Example:**

```go
client := aegis.NewServiceClient(pool, "identity", "v1", identity.NewIdentityServiceClient)
```

### ServiceClient.Get

```go
func (sc *ServiceClient[T]) Get(ctx context.Context) (T, error)
```

Returns a client connected to a provider.

---

## Context

### CallerFromContext

```go
func CallerFromContext(ctx context.Context) (*Caller, error)
```

Extracts caller identity from gRPC context.

**Errors:**
- `ErrNoPeerInfo` — No peer info in context
- `ErrNoTLSInfo` — Peer has no TLS info
- `ErrNoCertificate` — No client certificate

### MustCallerFromContext

```go
func MustCallerFromContext(ctx context.Context) *Caller
```

Extracts caller identity, panics on error. Use only when mTLS is guaranteed.

---

## Health

### NewHealthInfo

```go
func NewHealthInfo() *HealthInfo
```

Creates health info with unknown status.

### NewFunctionHealthChecker

```go
func NewFunctionHealthChecker(name string, fn func(context.Context) error) *FunctionHealthChecker
```

Creates a health checker from a function.

---

## TLS

### LoadOrGenerateTLS

```go
func LoadOrGenerateTLS(nodeID, certDir string) (*TLSConfig, error)
```

Loads certificates from directory, generating if missing.

### LoadTLSConfig

```go
func LoadTLSConfig(opts *TLSOptions) (*TLSConfig, error)
```

Loads TLS configuration from options.

---

## Next Steps

- [Types Reference](2.types.md) — Type definitions
- [Concepts](../1.learn/3.concepts.md) — Mental models
